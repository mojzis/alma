<div
    x-data="{
        content: '',
        expanded: false,
        wordCount: 0,
        valid: false,
        updateWordCount() {
            this.wordCount = this.content.trim().split(/\s+/).filter(w => w.length > 0).length;
            this.valid = this.content.trim().length > 0;
        }
    }"
>
    <!-- Form Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
        <h2 class="text-lg">New Note</h2>
        <span class="text-sm" style="color: var(--text-tertiary);">⌘N</span>
    </div>

    <form
        hx-post="/notes"
        hx-target="#notes-list"
        hx-swap="afterbegin"
        hx-on::after-request="if(event.detail.successful) { this.reset(); content = ''; expanded = false; wordCount = 0; }"
        aria-label="Create new note"
    >
        <!-- Metadata Row (Inline) -->
        <div style="display: grid; grid-template-columns: 140px 120px 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
            <!-- Project Dropdown -->
            <div>
                <select name="project" required style="padding: 8px 12px; font-size: 13px;" aria-label="Select project">
                    {% for project in projects_list %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Type Dropdown -->
            <div>
                <select name="content_type" required style="padding: 8px 12px; font-size: 13px;" aria-label="Select note type">
                    <option value="note">Note</option>
                    <option value="idea">Idea</option>
                    <option value="task">Task</option>
                    <option value="reference">Reference</option>
                </select>
            </div>

            <!-- Tags Input -->
            <div>
                <input
                    type="text"
                    name="tags"
                    placeholder="Add tags..."
                    style="padding: 8px 12px; font-size: 13px;"
                    aria-label="Add tags (comma-separated)"
                >
            </div>
        </div>

        <!-- Content Textarea -->
        <div class="form-group" style="margin-bottom: var(--spacing-md);">
            <textarea
                name="content"
                required
                x-model="content"
                @input="updateWordCount(); expanded = content.length > 0"
                placeholder="Start writing..."
                :style="expanded ? 'height: 520px;' : 'height: 300px;'"
                style="transition: height var(--transition-slow); font-size: 14px;"
                aria-label="Note content"
                aria-describedby="formatting-hints"
            ></textarea>
            <div style="text-align: right; margin-top: var(--spacing-sm);">
                <span class="text-sm" x-text="`${wordCount} words`"></span>
            </div>
        </div>

        <!-- Formatting Hints -->
        <div id="formatting-hints" class="text-sm" style="color: var(--text-tertiary); margin-bottom: var(--spacing-md);">
            Markdown supported: <code>**bold**</code> <code>*italic*</code> <code>[[wiki-link]]</code> <code>#tag</code>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; justify-content: flex-end; gap: var(--spacing-md);">
            <button
                type="button"
                class="secondary"
                @click="content = ''; expanded = false; wordCount = 0;"
                style="padding: 10px 20px;"
            >
                Cancel
            </button>
            <button
                type="submit"
                :disabled="!valid"
                style="padding: 10px 24px;"
            >
                <span class="htmx-indicator">Saving...</span>
                <span>Save Note</span>
            </button>
        </div>
    </form>

    <!-- Divider -->
    <div style="margin: var(--spacing-xl) 0; padding-top: var(--spacing-xl); border-top: 1px solid var(--border-light);">
        <p class="text-sm" style="color: var(--text-tertiary); text-align: center;">
            ↓ Recent notes below (scroll or press Tab+S to switch view)
        </p>
    </div>
</div>
